<!DOCTYPE html>
<html>
<head includeDefault="true">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>test scene</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
    <script src="js/three.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/libs/dat.gui.min.js"></script>
		<script src="https://threejsfundamentals.org/threejs/resources/threejs/r105/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div id="container"></div>
    <script>
				//<script src="https://threejsfundamentals.org/threejs/resources/threejs/r105/js/loaders/OBJLoader.js">
        var stats = initStats();
        var scene, camera, renderer, controls, gui, currentTime;
				var matArrayA=[];
        var matArrayB=[];
        var step = 0;
        var speed = 10;
        var group = new THREE.Group();

        function initScene() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog( scene.background, 3000, 5000 );
            var cubeGeometry = new THREE.CubeGeometry(100,100,100);
            var cubeMaterial = new THREE.MeshLambertMaterial({color: 0x00ffff});
            cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
            cube.position.x = 0;
            cube.position.y = 200;
            cube.position.z = 0;
            cube.castShadow = true;
            cube.receiveShadow = true;
            scene.add(cube);
        }
        function initGui() {
            gui = {
                ambientLight:"#111111",
                directionalLight:"#ffffff",
                intensity:1,
                debug:false,
                time:0,
                pause:false,
                speed:10
            };            
            var datGui = new dat.GUI();
            datGui.add(gui,"time",0 ,1440).onChange(function (e) {
              time = e;
            });
            datGui.add(gui,"speed",0 ,100).onChange(function (e) {
              speed = e;
            });
            datGui.add(gui,"pause").onChange(function (e) {
              if(e){
                cancelAnimationFrame(id);
              }
              else{
                requestAnimationFrame(animate);
              }
            });
            datGui.addColor(gui,"ambientLight").onChange(function (e) {
              ambientLight.color = new THREE.Color(e);
            });
            datGui.addColor(gui,"directionalLight").onChange(function (e) {
              directionalLight.color = new THREE.Color(e);
            });
            datGui.add(gui,"intensity",0,5).onChange(function (e) {
              directionalLight.intensity = e;
            });
          }
        // 初始化相机
        function initCamera() {
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 10000);
						//camera.shadowCameraVisible = true;
						camera.position.set(0, 800, 1500);
            camera.lookAt(new THREE.Vector3(0, 0, 0));
        }

        // 初始化灯光
        function initLight() {
            directionalLight = new THREE.DirectionalLight( 0xffffff, 0.8 );//模拟远处类似太阳的光源
            var target = new THREE.Object3D();
            target.position.set(0, 0, 0);
            scene.add(target);
						directionalLight.position.set( 500, 500, 0);
						directionalLight.castShadow = true;
						directionalLight.color.setHSL( 0.1, 1, 0.95 );
						directionalLight.shadow.camera.near = 10;
						directionalLight.shadow.camera.far = 1500;
						directionalLight.shadow.camera.left = -500;
						directionalLight.shadow.camera.right = 500;
						directionalLight.shadow.camera.top = 600;
						directionalLight.shadow.camera.bottom = -600;
						directionalLight.shadowCameraVisible = true;
						directionalLight.target = target;
            directionalLight.shadow.mapSize.height = 1024;
            directionalLight.shadow.mapSize.width = 1024;
            scene.add( directionalLight) ;

            var helper = new THREE.CameraHelper(directionalLight.shadow.camera);
            scene.add(helper);
            ambientLight = new THREE.AmbientLight( 0xFFFFFF, 0.2 ); //AmbientLight,影响整个场景的光源
            ambientLight.position.set(0,0,0);
            scene.add( ambientLight );

        }

        // 初始化性能插件
        function initStats() {
            var stats = new Stats();

            stats.domElement.style.position = 'absolute';
            stats.domElement.style.left = '0px';
            stats.domElement.style.top = '0px';

            document.body.appendChild(stats.domElement);
            return stats;
        }

        // 初始化渲染器
        function initRenderer() {
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x4682B4,1);
						renderer.shadowMapEnabled = true;
						renderer.shadowMapSoft = true;

            document.body.appendChild(renderer.domElement);
        }

        function createFloor(){
            var loader = new THREE.TextureLoader();
            loader.load("img/grass-texture.jpg",function(texture){
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 16, 16 );
                var floorGeometry = new THREE.PlaneGeometry(1000, 1000);
                var floorMaterial = new THREE.MeshLambertMaterial( { map: texture } );// side: THREE.DoubleSide
                var floor = new THREE.Mesh(floorGeometry, floorMaterial);
								floor.receiveShadow = true;
                floor.castShadow = true;
								floor.position.y = -0.5;
                floor.rotation.x = -Math.PI / 2;
                floor.name = "floor";
                scene.add(floor);
            });
        }

				function createCubeWall(width, height, depth, angle, material, x, y, z, name){
						var cubeGeometry = new THREE.BoxGeometry(width, height, depth );
						var cube = new THREE.Mesh( cubeGeometry, material );
						cube.castShadow = true;
						cube.receiveShadow = true;
						cube.position.x = x;
						cube.position.y = y;
						cube.position.z = z;
						cube.rotation.y += angle*Math.PI;
						cube.name = name;
						scene.add(cube);
				}
				function createWallMaterail(){
	            matArrayA.push(new THREE.MeshPhongMaterial({color: 0xafc0ca}));  //前  0xafc0ca :灰色
	            matArrayA.push(new THREE.MeshPhongMaterial({color: 0x9cb2d1}));  //后  0x9cb2d1：淡紫
	            matArrayA.push(new THREE.MeshPhongMaterial({color: 0xd6e4ec}));  //上  0xd6e4ec： 偏白色
	            matArrayA.push(new THREE.MeshPhongMaterial({color: 0xd6e4ec}));  //下
	            matArrayA.push(new THREE.MeshPhongMaterial({color: 0xafc0ca}));  //左   0xafc0ca :灰色
	            matArrayA.push(new THREE.MeshPhongMaterial({color: 0xafc0ca}));  //右

	      }
        // 初始化模型
        function initContent() {
            createFloor();
						createWallMaterail();
						createCubeWall(10, 50, 1000, 0, matArrayA, -500, 25, 0, "Wall");
						createCubeWall(10, 50, 1000, 0, matArrayA, 500, 25, 0, "Wall");
						createCubeWall(10, 50, 1000, 0.5, matArrayA, 0, 25, -500, "Wall");
						createCubeWall(10, 50, 1000, 0.5, matArrayA, 0, 25, 500, "Wall");
        }

        function initControls() {
            controls = new THREE.OrbitControls( camera, renderer.domElement );
            controls.enableDamping = true;
            controls.dampingFactor = 0.5;
            controls.minDistance = 100;
            controls.maxDistance = 2000;
            controls.maxPolarAngle = Math.PI/2.2;
            //controls.enablePan = true;
        }

        function update() {
            stats.update();
            controls.update();
        }

        //function updateLight(){
        //  directionalLight.target.updateMatrixWorld();
        //  helper.update();
        //}
        //updateLight();
        function init() {
            initScene();
            initCamera();
            initRenderer();
            initContent();
            initLight();
            initControls();
            initGui();
            document.addEventListener('resize', onWindowResize, false);
        }

        function movnigSun(obj,speed){
          step += speed;
          obj.position.x = 750*(Math.cos(step));
          obj.position.y = 750*(Math.sin(step));
          //obj.target.updateMatrixWorld();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            id = requestAnimationFrame(animate);
            movnigSun(directionalLight,speed * 0.0002);
            renderer.render(scene, camera);
            update();
        }
        init();
        animate();
    </script>
</body>
</html>
